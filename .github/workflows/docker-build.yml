name: Build and Push Docker Image

on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:
  schedule:
    # Rebuild weekly to get latest DVSwitch updates
    - cron: '0 0 * * 0'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image for testing
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: dvswitch-server:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run container and verify DVSwitch components
        run: |
          # Start the container in the background
          docker run -d --name dvswitch-test dvswitch-server:test
          
          # Wait for container to be ready with retry logic
          echo "=== Waiting for container to be ready ==="
          for i in {1..10}; do
            if docker exec dvswitch-test test -d /etc/dvswitch 2>/dev/null; then
              echo "Container is ready after $i attempts"
              break
            fi
            echo "Waiting for container... attempt $i/10"
            sleep 2
          done
          
          # Verify container is running
          echo "=== Checking container status ==="
          docker ps | grep dvswitch-test
          
          # Check if DVSwitch directories exist
          echo "=== Checking DVSwitch directories ==="
          docker exec dvswitch-test test -d /opt/MMDVM_Bridge && echo "✓ /opt/MMDVM_Bridge exists" || echo "✗ /opt/MMDVM_Bridge missing"
          docker exec dvswitch-test test -d /opt/Analog_Bridge && echo "✓ /opt/Analog_Bridge exists" || echo "✗ /opt/Analog_Bridge missing"
          
          # Check if DVSwitch management utility exists and is executable
          echo "=== Checking DVSwitch management utility ==="
          docker exec dvswitch-test test -x /usr/local/dvs/dvs && echo "✓ DVS management utility exists and is executable" || echo "✗ DVS management utility missing or not executable"
          
          # Check for MMDVM_Bridge binary (use -x to verify executable)
          echo "=== Checking MMDVM_Bridge binary ==="
          docker exec dvswitch-test test -x /opt/MMDVM_Bridge/MMDVM_Bridge && echo "✓ MMDVM_Bridge binary exists and is executable" || echo "✗ MMDVM_Bridge binary missing or not executable"
          
          # Check for Analog_Bridge binary (use -x to verify executable)
          echo "=== Checking Analog_Bridge binary ==="
          docker exec dvswitch-test test -x /opt/Analog_Bridge/Analog_Bridge && echo "✓ Analog_Bridge binary exists and is executable" || echo "✗ Analog_Bridge binary missing or not executable"
          
          # Check for md380-emu binary
          echo "=== Checking md380-emu binary ==="
          if docker exec dvswitch-test which md380-emu 2>/dev/null; then
            echo "✓ md380-emu found in PATH"
          elif docker exec dvswitch-test test -x /opt/md380-emu/md380-emu 2>/dev/null; then
            echo "✓ md380-emu found at /opt/md380-emu/"
          else
            echo "Note: md380-emu not found (optional component, may not be included in dvswitch-server package)"
          fi
          
          # Check for dvswitch.sh script (use -x to verify executable)
          echo "=== Checking dvswitch.sh script ==="
          docker exec dvswitch-test test -x /opt/MMDVM_Bridge/dvswitch.sh && echo "✓ dvswitch.sh exists and is executable" || echo "✗ dvswitch.sh missing or not executable"
          
          # List installed DVSwitch-related packages
          echo "=== Listing DVSwitch packages ==="
          docker exec dvswitch-test dpkg -l | grep -i dvswitch || echo "No dvswitch packages found via dpkg"
          
          # Show container logs
          echo "=== Container logs ==="
          docker logs dvswitch-test
          
          # Cleanup
          docker stop dvswitch-test
          docker rm dvswitch-test

  build:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/dvswitch-server
            ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Update Docker Hub description
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
          repository: ${{ secrets.DOCKERHUB_USERNAME }}/dvswitch-server
          readme-filepath: ./README.md
